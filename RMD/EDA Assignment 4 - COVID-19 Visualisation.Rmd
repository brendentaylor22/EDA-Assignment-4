---
title: "EDA Assignment 4 - COVID-19 Visualisation"
author: "Brenden Taylor"
date: "31/03/2020"
output: 
  bookdown::html_document2:
    number_sections: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = NA, warning = FALSE)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(gganimate)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggmap)
#library(tmap)
library(plotly)
library(sf)
library(spData)
library(countrycode)
library(googleVis)
#library(leaflet)
options(scipen=10000) #Remove scientific notation from ggplot legend
```

```{r get-data}
#Get latest COVID-19 data
#I don't run this in a separate file because I want the latest data every time the file is knit
ncov <- read.csv("https://raw.githubusercontent.com/datasets/covid-19/master/data/countries-aggregated.csv")
# convert Date from factor to date class
ncov <- ncov %>% 
  mutate(Date = ymd(Date))

#Get geometry data for the world and all its countries

#world_geom = world %>%
#  select(c("name_long", "continent", "region_un", "subregion", "pop", "geom"))

world_ne0 = ne_countries(scale = "medium", returnclass = "sf", type = "countries")
world_ne = world_ne0 %>%
  select(c(sovereignt, geometry))
```

```{r check-data, include = F}
#The COVID-19 data is assumed to be clean since the repo used claims to be the cleaned version of data from John's Hopkins. So no structural checks, NA checks etc. are done at this stage.
```

```{r add-geom-data}
#Need to add geometry data to ncov data
#First create column in ncov for World Bank country code. Will then use this code to join geometry data
ncov$iso3c = countrycode(sourcevar = ncov$Country, origin = "country.name", destination = "wb")

#Missing code for Holy See, Diamond Princess and MS Zaandam
#Need to replace Holy See with Vatican
ncov$Country = ncov$Country %>%
  recode("Holy See" = "Vatican") %>%
  recode("Taiwan*" = "Taiwan")

#Add code for missing countries
ncov = ncov %>%
  mutate(iso3c = ifelse(Country=="Vatican", "VAT", iso3c)) %>%
  mutate(iso3c = ifelse(Country=="Western Sahara", "ESH", iso3c)) %>%
  mutate(iso3c = ifelse(Country=="Diamond Princess", "CDP", iso3c)) %>%
  mutate(iso3c = ifelse(Country=="MS Zaandam", "CMZ", iso3c))

#Create column in world_geom for iso3c
# world_geom$iso3c = countrycode(sourcevar = world_geom$name_long, 
#                                origin = "country.name", destination = "wb")

world_ne$iso3c = countrycode(sourcevar = world_ne$sovereignt, 
                               origin = "country.name", destination = "wb")

#Few countries without countrycodes so need to insert manually
world_ne = world_ne %>%
  mutate(iso3c = ifelse(sovereignt == "Western Sahara", "ESH", iso3c)) %>%
  mutate(iso3c = ifelse(sovereignt == "Vatican", "VAT", iso3c))

#world_ne contains 2 Israel entries. Row 179 is West Bank and Gaza so will be renamed
world_ne[180,1] = "West Bank and Gaza"
world_ne = world_ne %>%
  mutate(iso3c = ifelse(sovereignt == "West Bank and Gaza", "PSE", iso3c))

#West Bank and Gaza still need geometry data. Use world_geom from world to extract geometry data and then add to world_ne
# palest = world_geom %>%
#   filter(name_long == "Palestine") %>%
#   select(c(name_long, geom)) %>%
#   mutate(iso3c = "PSE")
# 
# colnames(palest) = c("sovereignt", "geometry", "iso3c")
# 
# #Convert both to data frame and then rbind and convert back to sf
# palest_df = as.data.frame(palest)
# world_ne_df = as.data.frame(world_ne)
# world_ne_df2 = rbind(world_ne_df, palest_df)
# world_ne_full = st_as_sf(world_ne_df2)

#Join ncov and geometry data
dat = left_join(ncov, world_ne, by = c("iso3c"))
dat = dat %>%
  select(-sovereignt)

#As of 8 April, both Diamond Princess and MS Zaandam had been evacuated and passengers sent to their respective countries. These two cruise ships will be ignored when plotting on a map but will be kept for total cases/deaths/recovered etc.

dat_cruise = dat %>%
  filter(Country == "Diamond Princess") %>%
  filter(Country == "MS Zaandam")

dat = dat %>%
  filter(!(Country == "Diamond Princess")) %>%
  filter(!(Country == "MS Zaandam"))
```


```{r get-latest-data}
#Get latest ncov data. This can be used to plot the map since we only need one plot, whereas the dat dataset contains a repeated geometry for each observation
get_latest = function(df) {
  date_newest = max(ncov$Date)
  ncov_newest = df %>%
    filter(Date == date_newest)
  return(ncov_newest)
}

#See which country has no geometry data
#test = dat[st_is_empty(ncov_newest$geom),]
```

```{r get-pop-data}
#Get population data
pop_dat = googleVis::Population %>%
  select(c("Country", "Population")) %>%
  rename(country2 = Country) %>%
  rename(pop = Population)

#Add country codes as per above
pop_dat$iso3c = countrycode(sourcevar = pop_dat$country2, 
                               origin = "country.name", destination = "wb")
#Add Western Sahara and Vatican
pop_dat = pop_dat %>%
  mutate(iso3c = ifelse(country2 == "Western Sahara", "ESH", iso3c)) %>%
  mutate(iso3c = ifelse(country2 == "Vatican City", "VAT", iso3c))

#Add population data to dat
dat = left_join(dat, pop_dat, by = c("iso3c")) %>%
  select(-c("country2")) %>%
  mutate(pop = ifelse(Country == "Taiwan", 23780000, pop)) %>%
  mutate(pop = ifelse(Country == "South Sudan", 12580000, pop)) %>%
  mutate(pop = ifelse(Country == "Kosovo", 1831000, pop)) %>% #Add missing populations
  mutate(cases_per_mil = Confirmed*1000000/pop) #Calc cases per million
```

```{r test-plot}
ncov_newest = get_latest(df = dat)
plot = ggplot(data = ncov_newest) +
  geom_sf(aes(geometry = geometry, fill = cases_per_mil)) +
  scale_fill_gradient(low = "blue", high = "red")
#plot

ggplotly(plot)
```

```{r add-index}
#Add index to dat based on the date of the observation
dat$index = as.numeric(as.factor(dat$Date))
```

```{r add-centroids}
centers = st_centroid(dat$geometry)
# dat$centers = st_coordinates(centers)
dat = cbind(dat, st_coordinates(centers))

ncov_newest = get_latest(df = dat)
plot2 = ggplot(data = ncov_newest) +
  geom_sf(aes(geometry = geometry)) +
  geom_point(aes(x = X, y = Y,
                 size = Confirmed),
             shape = 21,
             colour = "turquoise",
             alpha = 0.4,
             fill = "blue") +
  scale_size_continuous(name = "Test",
                        range = c(0,10))
plot2

ggplotly(plot2)
```

```{r animation-cases-per-mil-map}
cases_min = min(dat$cases_per_mil)
cases_max = max(dat$cases_per_mil)

plot_test = ggplot(data = ncov_newest) +
  geom_sf(aes(geometry = geometry,
              fill = cases_per_mil)) +
  scale_fill_gradient(
    name = "Cases Per Million",
    low = "blue",
    high = "red",
    na.value = "gray",
    limits = c(cases_min, cases_max)
  ) +
  #scale_fill_viridis_b(name = "Cases Per Million", begin = 0, end = 1, limits = c(cases_min, cases_max), na.value = "gray") +
  theme_void() +
  guides(fill = guide_colorbar(title.position = "top")) +
  labs(title = "Life Expectancy, ") +
  theme(plot.title = element_text(
    hjust = 0.5,
    vjust = 0.05,
    size = 25
  )) +
  theme(plot.caption = element_text(
    hjust = 0,
    color = "gray40",
    size = 15
  )) +
  theme(
    legend.position = c(.5, .08),
    legend.direction = "horizontal",
    legend.title.align = 0,
    legend.key.size = unit(1.3, "cm"),
    legend.title = element_text(size = 17),
    legend.text = element_text(size = 13)
  )
plot_test
ggplotly(plot_test)

plot_anim = ggplot(data = dat) +
  geom_sf(aes(geometry = geometry, 
              fill = cases_per_mil)) +
  scale_fill_gradient(name = "Cases Per Million", low = "blue", high = "red", na.value = "gray") +
  #scale_fill_viridis_b(name = "Cases Per Million", begin = 0, end = 1, limits = c(cases_min, cases_max), na.value = "gray") +
  transition_manual(index)
  

animate(plot_anim, renderer = gifski_renderer(loop = TRUE), width = 600, height = 600)

anim_save(filename = "Cases Per Mil Over Time - World Map small.gif", 
          path = "C:/Users/brend/Documents/Masters - Local/EDA/Assignments/Assignment-4/Gifs")
```

```{r leaflet-plot-no-anim}
plot_no_anim = leaflet() %>%
  addTiles()

plot_no_anim
```


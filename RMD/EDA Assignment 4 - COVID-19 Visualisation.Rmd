---
title: "EDA Assignment 4 - COVID-19 Visualisation"
author: "Brenden Taylor"
date: "31/03/2020"
output: 
  bookdown::html_document2:
    number_sections: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = NA, warning = FALSE)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggmap)
library(tmap)
library(plotly)
library(sf)
library(spData)
library(countrycode)
```

```{r get-data}
#Get latest COVID-19 data
#I don't run this in a separate file because I want the latest data every time the file is knit
ncov <- read.csv("https://raw.githubusercontent.com/datasets/covid-19/master/data/countries-aggregated.csv")
# convert Date from factor to date class
ncov <- ncov %>% mutate(Date = ymd(Date))

#Get geometry data for the world and all its countries

world_geom = world %>%
  select(c("name_long", "continent", "region_un", "subregion", "pop", "geom"))

world_ne0 = ne_countries(scale = "medium", returnclass = "sf", type = "countries")
world_ne = world_ne0 %>%
  select(c(sovereignt, geometry))
```

```{r check-data, include = F}
#The COVID-19 data is assumed to be clean since the repo used claims to be the cleaned version of data from John's Hopkins. So no structural checks, NA checks etc. are done at this stage.
```

```{r add-geom-data}
#Need to add geometry data to ncov data
#First create column in ncov for World Bank country code. Will then use this code to join geometry data
ncov$iso3c = countrycode(sourcevar = ncov$Country, origin = "country.name", destination = "wb")

#Missing code for Holy See, Diamond Princess and MS Zaandam
#Need to replace Holy See with Vatican
ncov$Country = ncov$Country %>%
  recode("Holy See" = "Vatican")

#Add code for missing countries
ncov = ncov %>%
  mutate(iso3c = ifelse(Country=="Vatican", "VAT", iso3c)) %>%
  mutate(iso3c = ifelse(Country=="Western Sahara", "ESH", iso3c)) %>%
  mutate(iso3c = ifelse(Country=="Diamond Princess", "CDP", iso3c)) %>%
  mutate(iso3c = ifelse(Country=="MS Zaandam", "CMZ", iso3c))

#Create column in world_geom for iso3c
world_geom$iso3c = countrycode(sourcevar = world_geom$name_long, 
                               origin = "country.name", destination = "wb")

world_ne$iso3c = countrycode(sourcevar = world_ne$sovereignt, 
                               origin = "country.name", destination = "wb")

#Few countries without countrycodes so need to insert manually
world_ne = world_ne %>%
  mutate(iso3c = ifelse(sovereignt == "Western Sahara", "ESH", iso3c)) %>%
  mutate(iso3c = ifelse(sovereignt == "Vatican", "VAT", iso3c))

#West Bank and Gaza still need geometry data. Use world_geom from world to extract geometry data and then add to world_ne
palest = world_geom %>%
  filter(name_long == "Palestine") %>%
  select(c(name_long, geom)) %>%
  mutate(iso3c = "PSE")

colnames(palest) = c("sovereignt", "geometry", "iso3c")

#Convert both to data frame and then rbind and convert back to sf
palest_df = as.data.frame(palest)
world_ne_df = as.data.frame(world_ne)
world_ne_df2 = rbind(world_ne_df, palest_df)
world_ne_full = st_as_sf(world_ne_df2)

#Join ncov and geometry data
dat = left_join(ncov, world_ne_full, by = c("iso3c"))
dat = dat %>%
  select(-sovereignt)
```


```{r get-latest-data}
#Get latest ncov data. This can be used to plot the map since we only need one plot, whereas the dat dataset contains a repeated geometry for each observation
if (max(ncov$Date) != today()) {
  date_newest = today()-1
}else{date = today()}
ncov_newest = dat %>%
  filter(Date == date_newest)

#See which country has no geometry data
#test = dat[st_is_empty(ncov_newest$geom),]
```

```{r test-plot}
# world_points<- st_centroid(world)
# world_points <- cbind(world, st_coordinates(st_centroid(dat$geometry)))

#Have to remove Countries with no geometry data before turning into plotly plot
test = ncov_newest %>%
  filter(!(Country == "Diamond Princess")) %>%
  filter(!(Country == "MS Zaandam"))
plot = ggplot(data = test) +
  geom_sf(aes(geometry = test$geometry))
plot

ggplotly(plot)
```

# Section 1

## Section 1.1

## Section 1.2

### Section 1.2.1

# Section 2
---
output:
  bookdown::pdf_book:
    toc: true
    toc_depth: 3
    keep_tex: yes
    includes:
      in_header: "Preamble.tex"
      before_body: "Title.tex"
      number_sections: no
---

<!-- I make use of a LaTeX title page and template document. These are supplied in the ZIP folder but can be commented out if necessary. -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, comment = NA, fig.align = "center", fig.width = 4, fig.height = 4, fig.pos = "H", warning = F)
library(tidyverse)
library(ggplot2)
library(reshape2)
library(kableExtra)
```

```{r read_data}
#Set file path to your own directory here
df = readRDS("C:/Users/brend/Google Drive (brenden.taylor@uct.ac.za)/Master's/EDA/Assignments/Assignment 2/sportrisks.rds")
```

\newpage
\pagenumbering{arabic}
# Background to the Assignment

## The Study
The survey aimed to investigate how risky people perceive a certain sport to be, and how reckless people are when they engage in these activities. Each participant was shown a short scenario about someone engaging in a particular sport or activity. However, the stories varied slightly in the finer details.

## Aims of the Study
The study aimed to:

1. Investigate the relationships between these three measures of risk:
    + Perceptions of danger
    + Perceptions of recklessness
    + How much an individual should pay in insurance premiums to cover their particular sport or activity (if anything)
  
2. Investigate the factors that influence someone's perceptions of danger and recklessness.

## Goal of the Assignment
The goal of the assignement is to explore the dataset, using techniques introduced and discussed in our lectures, to address the aims mentioned [above][Aims of the Study].

# Tidying the Data
## Searcing for `NA`s
First, we take a look at the structure of the data, as well as the first and last three observations.

```{r str}
str(df)
head(df, 2)
tail(df, 2)
```

Based on the structure, we can see that there appear to be a few variables that are filled entirely with NAs, namely `Q5`, `Q5_a`, `Q6` and `Q6_a`. According to the survey outline, these questions don't exist and so we can remove them.

```{r remove_na_cols}
dat2 = Filter(function(x) !all(is.na(x)), df)
#Filter applies function to dat and only returns values where function == T
#all returns true if all values are true. So !all(is.na()) returns False if column is only NAs
#I.e. we're selecting all columns that have are not made up entirely of NAs 
```

We can also remove `Q1` as it records whether or not the participant agreed to participate - clearly they did!

```{r remove_q1}
dat2 = dat2[-c(dat2$Q1)]
```

Lastly, there are also `r sum(is.na(dat2$Q5_1))` `NA` values in the danger rating column. These observations will not be removed as they may still give us some useful information.

## Adjusting the Variables

Next, we rename the columns to something more intutive, and replace any values of `TRUE` with 1 and any values of `FALSE` with 0. We can also ensure that columns are factors where appropriate.

While we're at it, we might as well change the type of some of the variables to be more suitable. For example, we can set the sport of the person in the scenario to be a factor variable. We also recode the respondent's gender to be either "male", "female", "other" or "unspecified" instead of the numeric code that it is currently.

```{r rename_cols}
dat3 = dat2 %>%
  rename(gender_resp = Q3, 
         unk = Q4, 
         danger = Q5_1, 
         danger_conf = Q5_a_1, 
         reck = Q6_1, 
         reck_conf = Q6_a_1, 
         pay = Q7, 
         premium = Q7_a,
         golf = Q8_1,
         ski = Q8_2,
         rock_climbing = Q8_3,
         surfing = Q8_4,
         hills = Q8_5,
         running = Q8_6,
         undisc = Q8_7)

#Replace numeric genders with character strings so they can be used as factors
#Set type for each variable
dat4 = dat3 %>%
  mutate(gender_resp = ifelse(gender_resp == 1, "female", 
                              ifelse(gender_resp == 2, "male", 
                                     ifelse(gender_resp == 3, "other", 
                                            ifelse(gender_resp == 4, "unspecified", 
                                                   NA))))) %>%
  mutate(gender_resp = as.factor(gender_resp)) %>%
  mutate(dependents = as.numeric(dependents)) %>%
  mutate(charity = as.numeric(charity)) %>%
  mutate(low_competence = as.numeric(low_competence)) %>%
  mutate(guide = as.numeric(guide)) %>%
  mutate(extreme_risk = as.numeric(extreme_risk)) %>%
  mutate(sport = as.factor(sport)) %>%
  mutate(gender = as.factor(gender)) %>%
  mutate(danger_conf = as.factor(danger_conf)) %>%
  mutate(pay = ifelse(pay==2, 0, pay))

dat = dat4
```

## Other Changes

```{r 3_to_0}
dat5 = dat %>%
  mutate(pay = ifelse(pay==3, 0, pay))
```

* The `pay` column records whether or not a respondent thinks the person in the scenario should pay an insurance premium to take part in the specific sport. Hence, it makes no sense that the recorded values in the `pay` column are `r unique(dat$pay)`.  
Taking a look at the data in the `pay` column, we can see that there are multiple observations containing 3s. Since these observations have no value in their `premium` column, we can assume these observations should have 0s instead of 3s and we adjust accordingly.
  + After a quick `mutate()`, we can now see that the values in the `pay` column are `r unique(dat5$pay)`, which is what we want.
  
* The `reck` column has a max value of `r max(dat5$reck)`. It's unclear what this value should be and so the observation is removed entirely.

```{r}
dat6 = dat5 %>%
  filter(reck < 11)

dat = dat6
```

## Final Check

We check the structure again to make sure it is now what we expect it to be.

```{r str2}
str(dat)
```

This structure looks far more intuitive and we may now begin to visualise some of this data to unpack it.

# Exploring the Data

Exploration of the data will be done in line with the two goals outlined [above][Aims of the Study].

## Scenarios

First we note that there was not an equal representation of the sports in the scenarios that were posed to the respondents.

```{r table1}
#Used to check if each sport is fairly represented across the scenarios.
counts_per_sport = dat %>%
  group_by(sport) %>%
  summarise(counts = length(sport)) %>%
  mutate(sport = str_to_title(sport))

counts_per_sport = counts_per_sport %>%
  mutate(percentage = paste(round(counts/sum(counts)*100, digits = 2), "%", sep = ""))

counts_per_sport %>%
  kable(col.names = c("Sport", "Frequency", "Percentage"), 
        align = c("l", "r", "r"), 
        caption = "Frequency and percentage of each sport from the scenarios presented to respondents") %>%
  kable_styling(bootstrap_options = c("striped"), 
                full_width = F, 
                latex_options = c("hold_position"))
```

Table \@ref(tab:table1) shows us that the vast majority of scenarios presented to respondents involved skitouring. Since the representation of sports in the scenarios was not equal, we need to be careful about using visualisations and analyses that involve absolute values or frequencies.

## Respondents
Note the distribution of gender among the respondents.

```{r table2}
counts_per_gender = dat %>%
  select(gender_resp) %>%
  group_by(gender_resp) %>%
  summarise(counts = length(gender_resp))

counts_per_gender = counts_per_gender %>%
  mutate(percentage = paste(round(counts/sum(counts)*100, digits = 2), "%", sep = "")) %>%
  mutate(gender_resp = str_to_title(gender_resp))

counts_per_gender %>%
  kable(col.names = c("Gender", "Frequency", "Percentage"), 
        align = c("l", "r", "r"), 
        caption = "Frequency and percentage of the gender of respondents") %>%
  kable_styling(bootstrap_options = c("striped"), 
                full_width = F, 
                latex_options = c("hold_position"))
```

Table \@ref(tab:table2) shows us that there were far more female respondents than male respondents. The "Other" and "Unspecified" categories have very few respondents so analyses of these two categories is not recommended and is unlikely to yield any useful results.

## Perceptions of Danger and Recklessness

```{r danger_and_reck}
danger_all = dat %>%
  select(c(danger)) %>%
  rename(score = danger) %>%
  mutate(val = "Danger")

reck_all = dat %>%
  select(c(reck)) %>%
  rename(score = reck) %>%
  mutate(val = "Recklessness")

danger_reck = rbind(danger_all, reck_all)
  

plot_danger_reck = ggplot(data = danger_reck, aes(x = val, y = score, fill = val))
```

```{r danger-reck, fig.cap="Our first figure indicates the spread between the overall danger and recklessness ratings. Surprisingly, they appear to have the same median rating, although the recklessness ratings are slightly less dispersed but do have two outliers.", fig.height=3}
plot_danger_reck +
  geom_boxplot(outlier.colour = "red") +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Danger and Recklessness Ratings",
       x = "Rating",
       y = "Value") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0),
        legend.position = "")
```

```{r danger-vs-reck}
danger_vs_reck = dat %>%
  group_by()
```

```{r danger-vs-reck2, fig.cap = "We can see that certain combinations of recklessness rating are more common than others. Of course, further analysis is needed to determine if there is a correlation between the two, but we can already see that there appears to be a cluster in the low danger and recklessness rating area. We can also see that there are no values with very high recklessness ratings and low danger ratings, but there are a few with high danger ratings and low recklessness ratings. This implies that respondents might be of the view that one cannot be very reckless if the sport is not very dangerous.", fig.width=5}
ggplot(data = dat, aes(x = danger, y = reck)) +
  geom_count(aes(size = ..n.., color = ..n..)) +
  guides(color = "legend") +
  #scale_size_area() +
  labs(title = "Frequency of Each Combination of \nRecklessness and Danger Rating",
       x = "Danger Rating",
       y = "Recklessness Rating") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0)) #+
  #facet_wrap(~sport)
```

Figure \@ref(fig:danger-vs-reck2) could also be facetted by sport, but this was not noticeably different than the overall plot.

```{r danger_by_gender}
#Include graph of danger ratings by gender
danger_by_gender = dat %>%
  select(c(gender_resp, danger, sport)) %>%
  mutate(gender_resp = str_to_title(gender_resp)) %>%
  mutate(val = "danger") %>%
  rename(score = danger)
```

```{r recklessness_by_gender}
reck_by_gender = dat %>%
  select(c(gender_resp, reck)) %>%
  mutate(gender_resp = str_to_title(gender_resp))%>%
  mutate(val = "reck") %>%
  rename(score = reck)
```

```{r remove_outlier}
reck_by_gender = dat %>%
  select(c(gender_resp, reck, sport)) %>%
  mutate(gender_resp = str_to_title(gender_resp)) %>%
  mutate(val = "reck") %>%
  rename(score = reck)
```

```{r gender-danger-reck}
gender_danger_reck = 
  rbind(reck_by_gender, danger_by_gender) %>%
  filter(!is.na(score)) %>%
  mutate(sport = str_to_title(sport))

plot_gender_danger_reck = ggplot(gender_danger_reck, 
                                 aes(x = gender_resp, y = score, fill = val))
```

```{r gender-danger-reck2, fig.cap="This figure shows the spread of both danger and recklessness ratings per gender of the respondent. It's worth noting that the danger rating tends to have a median greater than or equal to that of the recklessness rating. This implies that respondents often viewed a scenario as dangerous but not reckless.", fig.width=8}
plot_gender_danger_reck +
  geom_boxplot(outlier.colour = "red") +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Rating Per Gender of Respondent",
       x = "Gender",
       y = "Rating") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0)) +
  scale_fill_discrete(name = "Rating", labels = c("Danger", "Recklessness"))
```

```{r gender-danger-reck-facet, fig.cap="Here we see the spread of both danger and recklessness ratings, grouped by gender and split based on the sport in the scenario. We can see that for some sports, like running and golf (and hillwalking, to some extent) the danger rating tended to be higher than the recklessness rating. We can also see that there doesn't appear to be any specific trend in terms of women and men finding particular sports dangerous or reckless.", fig.width=8}
plot_gender_danger_reck +
  geom_boxplot(outlier.colour = "red") +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Rating Per Gender of Respondent Grouped by Sport",
       x = "Gender",
       y = "Rating") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_discrete(name = "Rating", labels = c("Danger", "Recklessness")) +
  facet_wrap(~sport)
```


## Interactions Between Insurance Premium and Danger/Recklessness Ratings

```{r ins}
ins_per_danger = dat %>%
  select(c(danger, premium)) %>%
  mutate(danger = as.factor(danger))

plot_ins_per_danger = ggplot(data = ins_per_danger, 
                             aes(x = danger, 
                                 y = premium,
                                 color = danger))
```

```{r ins2, fig.cap="We can clearly see that there are a few outliers here that need to be considered. These outliers will be removed and the plot re-generated using a log-transformation on the y-axis to improve the visualisation. We will also use a grouped boxplot so we can visualise danger and recklessness ratings side-by-side.", fig.pos="H", fig.width=3, fig.height=3}
plot_ins_per_danger +
  geom_boxplot(outlier.colour = "red",
               na.rm = T) +
  theme(legend.position = "none") +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Insurance Premium Per \nDanger Rating",
       x = "Danger Rating",
       y = "Insurance Premium") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0))
```

```{r remove_outliers_ins, warning=FALSE}
dat = dat %>%
  filter(premium < 5000 | is.na(premium))

ins_per_danger = dat %>%
  select(c(danger, premium)) %>%
  mutate(danger = as.factor(danger))%>%
  rename(score = danger) %>%
  mutate(val = "danger")
```

```{r ins1, warning=FALSE}
ins_per_reck = dat %>%
  select(c(reck, premium)) %>%
  mutate(reck = as.factor(reck)) %>%
  rename(score = reck) %>%
  mutate(val = "reck")
```

```{r ins-danger-reck}
ins_danger_reck = 
  rbind(ins_per_danger, ins_per_reck) %>%
  filter(!is.na(premium)) %>%
  filter(!is.na(score))
  
plot_ins_danger_reck = ggplot(ins_danger_reck, aes(x = score, y = premium, fill = val))
```

```{r ins-danger-reck2, fig.cap = "Firstly, we note that there are quite a few outliers (according to Tukey's rule). Next, we can see that there appears to be an upward trend implying that respondents thought that the participants of the more dangerous and reckless sports should pay a higher premium. Interestingly though, there isn't much of a discrepancy between the suggested insurance premium for the different danger and recklessness ratings.", fig.width=8}
plot_ins_danger_reck + 
  geom_boxplot(outlier.color = "red",
               na.omit = T) +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Insurance Premium Per Rating Given \n(Log Scale)",
       x = "Rating",
       y = "Insurance Premium (Log)") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0)) +
  scale_y_log10() +
  scale_fill_discrete(name = "Rating", labels = c("Danger", "Recklessness"))
```

```{r mean_ins_per_sport}
mean_ins_bysport = dat %>%
  group_by(sport) %>%
  summarise(mean_ins = mean(premium, na.rm = T))

plot_ins_mean_bysport = ggplot(data = mean_ins_bysport, 
                             aes(x = sport, y = mean_ins))
```

```{r mean-ins-per-sport2, fig.cap="This figure shows the average premium suggested for each sport. It's interesting to note that these premiums don't match up with the associated mean danger rating per sport (see below). For example, surfing had only the third highest mean danger rating but has the highest suggested premium. This implies that respondents don't base their suggestions for insurance premiums purely on danger. However, these premiums match up far more closely to the mean recklessness ratings, so respondents might be basing their premium suggestions more closely on their view of how reckless the person is.", fig.height=3}
plot_ins_mean_bysport + 
  geom_bar(stat = "identity", fill = "lightblue", alpha = 0.8, colour = "lightblue") +
  geom_text(aes(label = round(mean_ins, 2), vjust = 1.1), color = "gray7") +
  labs(title = "Average Premium Per Sport", 
       x = "Sport",
       y = "Mean") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(angle = 45, 
                                   hjust = 1)) +
  scale_x_discrete(labels = c("Climbing", "Golf", "Hill Walking", 
                              "Running", "Ski-Touring", "Surfing"))
```

## Factors Influencing Perceptions of Danger and Recklessness

```{r mean_danger_per_sport}
mean_danger_bysport = dat %>%
  group_by(sport) %>%
  summarise(mean = mean(danger, na.rm = T)) %>%
  mutate(val = "Danger")
```

```{r mean_reck_per_sport}
mean_reck_bysport = dat %>%
  group_by(sport) %>%
  summarise(mean = mean(reck, na.rm = T)) %>%
  mutate(val = "Recklessness")
```

```{r mean-reck-danger}
mean_danger_reck = rbind(mean_danger_bysport, mean_reck_bysport)

plot_mean_danger_reck = ggplot(data = mean_danger_reck, 
                               aes(x = sport, y = mean, fill = val))
```


```{r mean-reck-danger2, fig.cap="The bar chart shows the mean danger and recklessness scores for each sport. We can see that, as one would expect, golf is perceived as the least dangerous while climbing is the most dangerous. In general, the ranking of most to least dangerous appears to follow the ranking of most to least reckless (with one or two exceptions). This seems to imply that there is some correlation between the two ratings.", fig.width=8}
plot_mean_danger_reck +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = round(mean, 2), vjust = 1.2), 
            position = position_dodge(1), 
            color = "gray7", 
            stat = "identity") +
  labs(title = "Average Rating Per Sport", 
       x = "Sport",
       y = "Mean") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(angle = 45, 
                                   hjust = 1)) +
  scale_x_discrete(labels = c("Climbing", "Golf", "Hill Walking", 
                              "Running", "Ski-Touring", "Surfing")) +
  scale_fill_discrete(name = "Rating", labels = c("Danger", "Recklessness"))
```

```{r reck_or_not}
reck2 = dat %>%
  select(c(reck, dependents, low_competence, guide, extreme_risk)) %>%
  filter(dependents == 1 | low_competence == 1 | guide == 1 | extreme_risk == 1)

reck2_melt = melt(reck2,
                 id.vars = c("reck"),
                 variable.name = "myVars",
                 value.name = "zeroOne")

reck2_melt = reck2_melt %>%
  filter(zeroOne == 1) %>%
  select(c(reck, myVars))

plot1 = ggplot(reck2_melt, aes(x = myVars, y = reck, color = myVars))
```

```{r reck-or-not2, fig.cap="This plot gives an interesting result in that the recklessness ratings for Low Competence, Guide and Extreme Risk all have the same spread. This could indicate a possible error in the data. We can also see that the spread of the recklessness rating is smaller when dependents are involved."}
plot1 +
  geom_boxplot(outlier.colour = "red") +
  theme(legend.position = "none") +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Recklessness Ratings Based on \nScenario Characteristics",
       x = "Scenario Characteristic",
       y = "Recklessness Rating") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0), 
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(labels = c("Dependents", "Low Competence", "Guide", "Extreme Risk"))
```



```{r plot1}
danger_sports = dat %>%
  select(c(danger, sport, golf, ski, rock_climbing, surfing, hills, running)) %>%
  mutate(sport = str_to_title(sport))

#Golf
danger_golf = danger_sports %>%
  filter(golf == 1) %>%
  select(danger, sport) %>%
  mutate(sport_resp = "Golf")

#Ski
danger_ski = danger_sports %>%
  filter(ski == 1) %>%
  select(danger, sport) %>%
  mutate(sport_resp = "Ski-Touring")

#rock_climbing
danger_rock_climbing = danger_sports %>%
  filter(rock_climbing == 1) %>%
  select(danger, sport) %>%
  mutate(sport_resp = "Rock Climbing")

#surfing
danger_surfing = danger_sports %>%
  filter(surfing == 1) %>%
  select(danger, sport) %>%
  mutate(sport_resp = "Surfing")

#hills
danger_hills = danger_sports %>%
  filter(hills == 1) %>%
  select(danger, sport) %>%
  mutate(sport_resp = "Hill Walking")

#running
danger_running = danger_sports %>%
  filter(running == 1) %>%
  select(danger, sport) %>%
  mutate(sport_resp = "Running")

#Join the above
danger_all = rbind(danger_golf, danger_ski, danger_rock_climbing, danger_surfing, 
                   danger_hills, danger_running) %>%
  rename(score = danger) %>%
  mutate(val = "Danger")

#Repeat for recklessness
reck_sports = dat %>%
  select(c(reck, sport, golf, ski, rock_climbing, surfing, hills, running)) %>%
  mutate(sport = str_to_title(sport))

#Golf
reck_golf = reck_sports %>%
  filter(golf == 1) %>%
  select(reck, sport) %>%
  mutate(sport_resp = "Golf")

#Ski
reck_ski = reck_sports %>%
  filter(ski == 1) %>%
  select(reck, sport) %>%
  mutate(sport_resp = "Ski-Touring")

#rock_climbing
reck_rock_climbing = reck_sports %>%
  filter(rock_climbing == 1) %>%
  select(reck, sport) %>%
  mutate(sport_resp = "Rock Climbing")

#surfing
reck_surfing = reck_sports %>%
  filter(surfing == 1) %>%
  select(reck, sport) %>%
  mutate(sport_resp = "Surfing")

#hills
reck_hills = reck_sports %>%
  filter(hills == 1) %>%
  select(reck, sport) %>%
  mutate(sport_resp = "Hill Walking")

#running
reck_running = reck_sports %>%
  filter(running == 1) %>%
  select(reck, sport) %>%
  mutate(sport_resp = "Running")

#Join the above
reck_all = rbind(reck_golf, reck_ski, reck_rock_climbing, reck_surfing, 
                   reck_hills, reck_running) %>%
  rename(score = reck) %>%
  mutate(val = "Recklessness")


danger_reck_all = rbind(danger_all, reck_all)






plot_test = ggplot(data = danger_reck_all, aes(x = sport, y = score, 
                                          fill = val))
```

```{r plot2, fig.cap = "This final plot shows both the danger and recklessness ratings for each sport in the scenario but grouped based on the sport(s) that the respondent participates in. It appears that the more 'extreme' sports like rock climbing, ski-touring and surfing all view rock climbing as dangerous but significantly less reckless than dangerous. Of course, there is also a tendency for participants of a sport to view their particular sport as less reckless than dangerous.", fig.width=8, fig.height=7}
plot_test +
  geom_boxplot(outlier.color = "red") + 
  facet_wrap(~sport_resp) +
  labs(title = "Danger Ratings Per Sport Grouped by \nRespondent's Sport",
       x = "Scenario Sport",
       y = "Danger Rating") +
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1),
        plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0)) +
  scale_color_brewer(palette = "Set1") +
  scale_fill_discrete(name = "Rating", labels = c("Danger", "Recklessness"))
```

